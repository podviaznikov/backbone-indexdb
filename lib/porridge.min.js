// (c) 2011 Enginimation Studio (http://enginimation.com).
// porridge.js may be freely distributed under the MIT license.
"use strict";var global=this,indexedDB=global.indexedDB||global.webkitIndexedDB,IDBTransaction=global.IDBTransaction||global.webkitIDBTransaction,IDBKeyRange=global.IDBKeyRange||global.webkitIDBKeyRange,Porridge={version:"0.3",db:null,log:function(a){console.log(a)},info:function(a){console.info(a)},init:function(a,b,c){var d=indexedDB.open(a.dbName,a.dbDescription),e=a.dbVersion;d.onsuccess=function(d){var f=d.target.result;Porridge.db=f;if(e!=f.version){var g=f.setVersion(e);g.onfailure=c||Porridge.log,g.onsuccess=function(c){for(var d=0;d<a.stores.length;d++){var e=a.stores[d],g=f.createObjectStore(e.name,e.key,!0);if(e.indexes)for(var h=0;h<e.indexes.length;h++){var i=e.indexes[h];g.createIndex(i.name,i.field||i.name)}}Porridge.log("initialized db"),b()}}else b()},d.onfailure=c||this.log},all:function(a,b,c,d){var e=this.db.transaction([a],IDBTransaction.READ_WRITE,0),f=e.objectStore(a),g=f.openCursor();g.onsuccess=function(a){var d=a.result||a.target.result;if(!d)c&&c();else{var e=d.value;b(e),d.continue()}},g.onerror=d||this.log},save:function(a,b,c,d){var e=this.db.transaction([a],IDBTransaction.READ_WRITE,0),f=e.objectStore(a),g=f.put(b,c);g.onsuccess=Porridge.info,g.onerror=d||this.log},remove:function(a,b,c,d){var e=this.db.transaction([a],IDBTransaction.READ_WRITE,0),f=e.objectStore(a),g=f.delete(b);g.onsuccess=c,g.onerror=d||this.log},allByKey:function(a,b,c,d,e,f){var g=this.db.transaction([a],IDBTransaction.READ_WRITE,0),h=g.objectStore(a),i=h.index(b),j=new IDBKeyRange.only(c),k=i.openCursor(j);k.onsuccess=function(a){var b=a.result||a.target.result;if(!b)e&&e();else{var c=b.value;d(c),b.continue()}},k.onerror=f||this.log}}